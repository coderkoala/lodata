<?php

namespace Flat3\Lodata\Tests\Protocol;

use Flat3\Lodata\Tests\TestCase;
use Flat3\Lodata\Type;

class TypesTest extends TestCase
{
    public function typeProvider()
    {
        return [
            [
                Type\Binary::class,
                'toUrl' => [
                    [null, 'null'],
                    ['aGVsbG8=', 'aGVsbG8'],
                    ['7/s5mg==', '7_s5mg'],
                    ['7_s5mg', '7_s5mg'],
                    ['hello', 'aGVsbG8'],
                ],
                'toJson' => [
                    [null, null],
                    ['aGVsbG8=', 'aGVsbG8='],
                    ['7/s5mg==', '7/s5mg=='],
                    ['7_s5mg', '7/s5mg=='],
                    ['hello', 'aGVsbG8='],
                ],
            ],
            [
                Type\Boolean::class,
                'toUrl' => [
                    [null, 'null'],
                    ['true', 'true'],
                    ['false', 'false'],
                    [true, 'true'],
                    [false, 'false'],
                    [0, 'false'],
                    [1, 'true'],
                    ['', 'false'],
                    [NAN, 'true'],
                ],
                'toJson' => [
                    [null, null],
                    ['true', true],
                    ['false', false],
                    [true, true],
                    [false, false],
                    [0, false],
                    [1, true],
                    ['', false],
                    [NAN, true],
                ],
            ],
            [
                Type\Byte::class,
                'toUrl' => [
                    [null, 'null'],
                    [0, '0'],
                    [-1, '255'],
                    [1, '1'],
                    [255, '255'],
                    [256, '0'],
                    [INF, '0'],
                    [NAN, '0'],
                    [0.1, '0'],
                    [1.2, '1'],
                ],
                'toJson' => [
                    [null, null],
                    [0, 0],
                    [-1, 255],
                    [1, 1],
                    [255, 255],
                    [256, 0],
                    [INF, 0],
                    [NAN, 0],
                    [0.1, 0],
                    [1.2, 1],
                ],
            ],
            [
                Type\Date::class,
                'toUrl' => [
                    [null, 'null'],
                    [0, '1970-01-01'],
                    ['2020-01-01', '2020-01-01'],
                    ['2020-01-02 23:23:23', '2020-01-02'],
                ],
                'toJson' => [
                    [null, null],
                    [0, '1970-01-01'],
                    ['2020-01-01', '2020-01-01'],
                    ['2020-01-02 23:23:23', '2020-01-02'],
                ],
            ],
            [
                Type\DateTimeOffset::class,
                'toUrl' => [
                    [null, 'null'],
                    [0, '1970-01-01T00%3A00%3A00%2B00%3A00'],
                    ['2020-01-01', '2020-01-01T00%3A00%3A00%2B00%3A00'],
                    ['2020-01-01 23:23:23', '2020-01-01T23%3A23%3A23%2B00%3A00'],
                    ['2020-01-01T23:23:23+00:01', '2020-01-01T23%3A23%3A23%2B00%3A01'],
                    ['2021-01-01T23%3A23%3A23%2B00%3A01', '2021-01-01T23%3A23%3A23%2B00%3A01'],
                ],
                'toJson' => [
                    [null, null],
                    [0, '1970-01-01T00:00:00+00:00'],
                    ['2020-01-01', '2020-01-01T00:00:00+00:00'],
                    ['2020-01-01 23:23:23', '2020-01-01T23:23:23+00:00'],
                    ['2020-01-01T23:23:23+00:01', '2020-01-01T23:23:23+00:01'],
                    ['2021-01-01T23%3A23%3A23%2B00%3A01', '2021-01-01T23:23:23+00:01'],
                ],
            ],
            [
                Type\Decimal::class,
                'toUrl' => [
                    [null, 'null'],
                    [0, '0'],
                    [1.0, '1'],
                    [1.1, '1.1'],
                    [NAN, 'NaN'],
                    [INF, 'INF'],
                    [-INF, '-INF'],
                    [-1, '-1'],
                    [-1.0, '-1'],
                    [2 ** 32, '4294967296'],
                    [2 ** 64, '1.844674407371e+19'],
                    [M_PI, '3.1415926535898'],
                    [M_PI / 2 ** 16, '4.7936899621426e-5'],
                ],
                'toJson' => [
                    [null, null],
                    [0, 0.0],
                    [1.0, 1.0],
                    [1.1, 1.1],
                    [NAN, 'NaN'],
                    [INF, 'INF'],
                    [-INF, '-INF'],
                    [-1, -1.0],
                    [-1.0, -1.0],
                    [2 ** 32, 4294967296.0],
                    [2 ** 64, 1.8446744073709552E+19],
                    [M_PI, 3.141592653589793],
                    [M_PI / 2 ** 16, 4.7936899621426287E-5],
                ],
                'toJsonIeee754' => [
                    [null, null],
                    [0, '0'],
                    [1.0, '1.000000000000000'],
                    [1.1, '1.100000000000000'],
                    [NAN, 'NaN'],
                    [INF, 'INF'],
                    [-INF, '-INF'],
                    [-1, '-1'],
                    [-1.0, '-1'],
                    [2 ** 32, '4294967296.000000'],
                    [2 ** 64, '18446744073709551616'],
                    [M_PI, '3.141592653589793'],
                    [M_PI / 2 ** 16, '0.00004793689962142629'],
                    [M_PI / 2 ** 32, '0.0000000007314590396335798'],
                ],
            ],
            [
                Type\Duration::class,
                'toUrl' => [
                    [null, 'null'],
                    [3, "'PT3S'"],
                    [3.5, "'PT3.5S'"],
                    [64, "'PT1M4S'"],
                    [367485.122, "'P4DT6H4M45.121999999974S'"],
                    [246834567345, "'P2856881DT13H35M45S'"],
                    ['PT3S', "'PT3S'"],
                    ['PT3.5S', "'PT3.5S'"],
                    ['PT1M4S', "'PT1M4S'"],
                    ['P4DT6H4M45.121999999974S', "'P4DT6H4M45.121999999974S'"],
                    ['P2856881DT13H35M45S', "'P2856881DT13H35M45S'"],
                ],
                'toJson' => [
                    [null, null],
                    [3, 'PT3S'],
                    [3.5, 'PT3.5S'],
                    [64, 'PT1M4S'],
                    [367485.122, 'P4DT6H4M45.121999999974S'],
                    [246834567345, 'P2856881DT13H35M45S'],
                    ['PT3S', 'PT3S'],
                    ['PT3.5S', 'PT3.5S'],
                    ['PT1M4S', 'PT1M4S'],
                    ['P4DT6H4M45.121999999974S', 'P4DT6H4M45.121999999974S'],
                    ['P2856881DT13H35M45S', 'P2856881DT13H35M45S'],
                ],
            ],
            [
                Type\Guid::class,
                'toUrl' => [
                    [null, 'null'],
                    ['2D1B80E8-0DAD-4EE7-AB6F-AE9FEC896290', '2D1B80E8-0DAD-4EE7-AB6F-AE9FEC896290'],
                    ['00000000-0000-0000-0000-000000000000', '00000000-0000-0000-0000-000000000000'],
                ],
                'toJson' => [
                    [null, null],
                    ['2D1B80E8-0DAD-4EE7-AB6F-AE9FEC896290', '2D1B80E8-0DAD-4EE7-AB6F-AE9FEC896290'],
                    ['00000000-0000-0000-0000-000000000000', '00000000-0000-0000-0000-000000000000'],
                ],
            ],
            [
                Type\Int16::class,
                'toUrl' => [
                    [null, 'null'],
                    [0, '0'],
                    [1.1, '1'],
                    [-1, '-1'],
                    [512, '512'],
                    [32768, '-32768'],
                    [32767, '32767'],
                    [-32767, '-32767'],
                ],
                'toJson' => [
                    [null, null],
                    [0, 0],
                    [1.1, 1],
                    [-1, -1],
                    [512, 512],
                    [32768, -32768],
                    [32767, 32767],
                    [-32767, -32767],
                ],
            ],
            [
                Type\Int32::class,
                'toUrl' => [
                    [null, 'null'],
                    [0, '0'],
                    [1.1, '1'],
                    [-1, '-1'],
                    [512, '512'],
                    [32768, '32768'],
                    [32767, '32767'],
                    [-32767, '-32767'],
                    [2147483647, '2147483647'],
                    [2147483648, '-2147483648'],
                ],
                'toJson' => [
                    [null, null],
                    [0, 0],
                    [1.1, 1],
                    [-1, -1],
                    [512, 512],
                    [32768, 32768],
                    [32767, 32767],
                    [-32767, -32767],
                    [2147483647, 2147483647],
                    [2147483648, -2147483648],
                ],
            ],
            [
                Type\Int64::class,
                'toUrl' => [
                    [null, 'null'],
                    [0, '0'],
                    [1.1, '1'],
                    [-1, '-1'],
                    [512, '512'],
                    [32768, '32768'],
                    [32767, '32767'],
                    [-32767, '-32767'],
                    [2147483647, '2147483647'],
                    [2147483648, '2147483648'],
                    [9223372036854775807, '9223372036854775807'],
                    [-9223372036854775807, '-9223372036854775807'],
                ],
                'toJson' => [
                    [null, null],
                    [0, 0],
                    [1.1, 1],
                    [-1, -1],
                    [512, 512],
                    [32768, 32768],
                    [32767, 32767],
                    [-32767, -32767],
                    [2147483647, 2147483647],
                    [2147483648, 2147483648],
                    [9223372036854775807, 9223372036854775807],
                    [-9223372036854775807, -9223372036854775807],
                ],
            ],
            [
                Type\SByte::class,
                'toUrl' => [
                    [null, 'null'],
                    [0, '0'],
                    [-1, '-1'],
                    [1, '1'],
                    [128, '-128'],
                    [255, '-1'],
                    [256, '0'],
                    [INF, '0'],
                    [NAN, '0'],
                    [0.1, '0'],
                    [1.2, '1'],
                ],
                'toJson' => [
                    [null, null],
                    [0, 0],
                    [-1, -1],
                    [1, 1],
                    [128, -128],
                    [255, -1],
                    [256, 0],
                    [INF, 0],
                    [NAN, 0],
                    [0.1, 0],
                    [1.2, 1],
                ],
            ],
            [
                Type\Stream::class,
                'toUrl' => [
                    [null, 'null'],
                    ['hello', "'aGVsbG8='"],
                    ['', "''"],
                    ["hell'o", "'aGVsbCdv'"],
                    [0, "'MA=='"],
                ],
                'toJson' => [
                    [null, null],
                    ['hello', 'aGVsbG8='],
                    ['', ''],
                    ["hell'o", 'aGVsbCdv'],
                    [0, 'MA=='],
                ],
            ],
            [
                Type\String_::class,
                'toUrl' => [
                    [null, 'null'],
                    ['hello', "'hello'"],
                    ['', "''"],
                    ["hell'o", "'hell''o'"],
                    [0, "'0'"],
                ],
                'toJson' => [
                    [null, null],
                    ['hello', 'hello'],
                    ['', ''],
                    ["hell'o", "hell'o"],
                    [0, '0'],
                ],
            ],
            [
                Type\TimeOfDay::class,
                'toUrl' => [
                    [null, 'null'],
                    [0, '00%3A00%3A00.000000'],
                    ['2020-01-01', '00%3A00%3A00.000000'],
                    ['2020-01-02 23:23:23', '23%3A23%3A23.000000'],
                    ['2020-01-02 23:23:23.3333', '23%3A23%3A23.333300'],
                ],
                'toJson' => [
                    [null, null],
                    [0, '00:00:00.000000'],
                    ['2020-01-01', '00:00:00.000000'],
                    ['2020-01-02 23:23:23', '23:23:23.000000'],
                    ['2020-01-02 23:23:23.3333', '23:23:23.333300'],
                ],
            ],
        ];
    }

    /**
     * @dataProvider typeProvider
     */
    public function test_types(string $type, array $toUrl, array $toJson)
    {
        foreach (['toUrl', 'toJson'] as $method) {
            foreach ($$method as $fromto) {
                list ($from, $to) = $fromto;

                $this->assertSame(
                    $to, (new $type($from))->$method(),
                    $type.'('.(string) $from.')::'.$method.' -> '.$to
                );
            }
        }
    }
}
